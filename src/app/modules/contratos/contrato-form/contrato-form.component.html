<div class="contrato-form-container">
  <h2>{{ isEditMode ? 'Editar Contrato' : 'Crear Contrato' }}</h2>

  <!-- Loading Spinner -->
  <mat-spinner *ngIf="isLoading" diameter="50" style="margin: 20px auto;"></mat-spinner>

  <!-- Debug Information -->
  <div *ngIf="!isLoading" class="debug-info">
    <p>Proveedores cargados: {{ proveedores.length }}</p>
    <p>Departamentos cargados: {{ departamentos.length }}</p>
    <p>Tipos de contrato cargados: {{ tiposContrato.length }}</p>
  </div>

  <form [formGroup]="contratoForm" (ngSubmit)="onSubmit()" *ngIf="!isLoading">
    <mat-form-field appearance="outline">
      <mat-label>Número de Contrato</mat-label>
      <input matInput type="number" formControlName="no_contrato" required>
      <mat-error *ngIf="contratoForm.get('no_contrato')?.hasError('required')">
        El número de contrato es obligatorio.
      </mat-error>
      <mat-error *ngIf="contratoForm.get('no_contrato')?.hasError('min')">
        El número debe ser mayor a 0.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Observaciones</mat-label>
      <textarea matInput formControlName="observaciones" required></textarea>
      <mat-error *ngIf="contratoForm.get('observaciones')?.hasError('required')">
        Las observaciones son obligatorias.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Valor CUP</mat-label>
      <input matInput type="number" formControlName="valor_cup" required>
      <mat-error *ngIf="contratoForm.get('valor_cup')?.hasError('required')">
        El valor CUP es obligatorio.
      </mat-error>
      <mat-error *ngIf="contratoForm.get('valor_cup')?.hasError('min')">
        El valor debe ser mayor o igual a 0.
      </mat-error>
    </mat-form-field>

   <!-- Replace the date input fields with these improved versions -->
<mat-form-field appearance="outline">
  <mat-label>Fecha de Entrada</mat-label>
  <input matInput [matDatepicker]="pickerEntrada" formControlName="fecha_entrada" required>
  <mat-datepicker-toggle matSuffix [for]="pickerEntrada"></mat-datepicker-toggle>
  <mat-datepicker #pickerEntrada></mat-datepicker>
  <mat-error *ngIf="contratoForm.get('fecha_entrada')?.hasError('required')">
    La fecha de entrada es obligatoria.
  </mat-error>
</mat-form-field>

<mat-form-field appearance="outline">
  <mat-label>Fecha Vencido</mat-label>
  <input matInput [matDatepicker]="pickerVencido" formControlName="fecha_vencido" required>
  <mat-datepicker-toggle matSuffix [for]="pickerVencido"></mat-datepicker-toggle>
  <mat-datepicker #pickerVencido></mat-datepicker>
  <mat-error *ngIf="contratoForm.get('fecha_vencido')?.hasError('required')">
    La fecha vencido es obligatoria.
  </mat-error>
</mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Proveedor</mat-label>
      <mat-select formControlName="proveedor_id" required>
        <mat-option *ngFor="let proveedor of proveedores" [value]="proveedor.id">
          {{ proveedor.nombre || 'Sin nombre' }}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="contratoForm.get('proveedor_id')?.hasError('required')">
        El proveedor es obligatorio.
      </mat-error>
      <mat-error *ngIf="contratoForm.get('proveedor_id')?.hasError('min')">
        Seleccione un proveedor válido.
      </mat-error>
      <button mat-icon-button matSuffix (click)="openNewProveedorDialog()" type="button">
        <mat-icon>add</mat-icon>
      </button>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Tipo de Contrato</mat-label>
      <mat-select formControlName="tipo_contrato_id" required>
        <mat-option *ngFor="let tipo of tiposContrato" [value]="tipo.id">
          {{ tipo.nombre_tipo_contrato || 'Sin nombre' }}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="contratoForm.get('tipo_contrato_id')?.hasError('required')">
        El tipo de contrato es obligatorio.
      </mat-error>
      <mat-error *ngIf="contratoForm.get('tipo_contrato_id')?.hasError('min')">
        Seleccione un tipo de contrato válido.
      </mat-error>
      <button mat-icon-button matSuffix (click)="openNewTipoContratoDialog()" type="button">
        <mat-icon>add</mat-icon>
      </button>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Departamento</mat-label>
      <mat-select formControlName="departamento_id" required>
        <mat-option *ngFor="let departamento of departamentos" [value]="departamento.id">
          {{ departamento.nombre|| 'Sin nombre' }}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="contratoForm.get('departamento_id')?.hasError('required')">
        El departamento es obligatorio.
      </mat-error>
      <mat-error *ngIf="contratoForm.get('departamento_id')?.hasError('min')">
        Seleccione un departamento válido.
      </mat-error>
      <button mat-icon-button matSuffix (click)="openNewDepartamentoDialog()" type="button">
        <mat-icon>add</mat-icon>
      </button>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Estado</mat-label>
      <mat-select formControlName="estado" required>
        <mat-option value="activo">Activo</mat-option>
        <mat-option value="inactivo">Inactivo</mat-option>
      </mat-select>
      <mat-error *ngIf="contratoForm.get('estado')?.hasError('required')">
        El estado es obligatorio.
      </mat-error>
    </mat-form-field>

    <!-- Optional Fields -->
    <mat-form-field appearance="outline">
      <mat-label>Vigencia</mat-label>
      <mat-select formControlName="vigencia_id">
        <mat-option *ngFor="let vigencia of vigenciasContrato" [value]="vigencia.id">
          {{ vigencia.vigencia }}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="contratoForm.get('vigencia_id')?.hasError('min')">
        Seleccione una vigencia válida.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Fecha Firmado</mat-label>
      <input matInput [matDatepicker]="pickerFirmado" formControlName="fecha_firmado" >
      <mat-datepicker-toggle matSuffix [for]="pickerFirmado"></mat-datepicker-toggle>
      <mat-datepicker #pickerFirmado></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Monto Vencimiento CUP</mat-label>
      <input matInput type="number" formControlName="monto_vencimiento_cup">
      <mat-error *ngIf="contratoForm.get('monto_vencimiento_cup')?.hasError('min')">
        El monto debe ser mayor o igual a 0.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Monto Vencimiento CL</mat-label>
      <input matInput type="number" formControlName="monto_vencimiento_cl">
      <mat-error *ngIf="contratoForm.get('monto_vencimiento_cl')?.hasError('min')">
        El monto debe ser mayor o igual a 0.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Valor USD</mat-label>
      <input matInput type="number" formControlName="valor_usd">
      <mat-error *ngIf="contratoForm.get('valor_usd')?.hasError('min')">
        El valor debe ser mayor o igual a 0.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Monto Vencimiento USD</mat-label>
      <input matInput type="number" formControlName="monto_vencimiento_usd">
      <mat-error *ngIf="contratoForm.get('monto_vencimiento_usd')?.hasError('min')">
        El monto debe ser mayor o igual a 0.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Valor Monto Restante</mat-label>
      <input matInput type="number" formControlName="valor_monto_restante">
      <mat-error *ngIf="contratoForm.get('valor_monto_restante')?.hasError('min')">
        El valor debe ser mayor o igual a 0.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>No. Contrato Contratación</mat-label>
      <input matInput type="number" formControlName="no_contrato_contratacion">
      <mat-error *ngIf="contratoForm.get('no_contrato_contratacion')?.hasError('min')">
        El número debe ser mayor a 0.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>No. Comité Contratación</mat-label>
      <input matInput type="number" formControlName="no_comite_contratacion">
      <mat-error *ngIf="contratoForm.get('no_comite_contratacion')?.hasError('min')">
        El número debe ser mayor a 0.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Fecha Comité Contratación</mat-label>
      <input matInput [matDatepicker]="pickerComiteContratacion" formControlName="fecha_comite_contratacion" (dateChange)="console.log('Fecha comité contratación selected:', $event.value)">
      <mat-datepicker-toggle matSuffix [for]="pickerComiteContratacion"></mat-datepicker-toggle>
      <mat-datepicker #pickerComiteContratacion></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>No. Acuerdo Comité Contratación</mat-label>
      <input matInput type="number" formControlName="no_acuerdo_comite_contratacion">
      <mat-error *ngIf="contratoForm.get('no_acuerdo_comite_contratacion')?.hasError('min')">
        El número debe ser mayor a 0.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Fecha Comité Administración</mat-label>
      <input matInput [matDatepicker]="pickerComiteAdmin" formControlName="fecha_comite_administracion" (dateChange)="console.log('Fecha comité administración selected:', $event.value)">
      <mat-datepicker-toggle matSuffix [for]="pickerComiteAdmin"></mat-datepicker-toggle>
      <mat-datepicker #pickerComiteAdmin></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>No. Comité Administración</mat-label>
      <input matInput type="number" formControlName="no_comite_administracion">
      <mat-error *ngIf="contratoForm.get('no_comite_administracion')?.hasError('min')">
        El número debe ser mayor a 0.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>No. Acuerdo Comité Administración</mat-label>
      <input matInput type="number" formControlName="no_acuerdo_comite_administracion">
      <mat-error *ngIf="contratoForm.get('no_acuerdo_comite_administracion')?.hasError('min')">
        El número debe ser mayor a 0.
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Entidad</mat-label>
      <input matInput formControlName="entidad">
    </mat-form-field>

    <div class="form-actions">
      <button mat-raised-button color="primary" type="submit" [disabled]="isLoading || proveedores.length === 0 || departamentos.length === 0 || tiposContrato.length === 0">
        {{ isLoading ? 'Guardando...' : (isEditMode ? 'Actualizar' : 'Crear') }}
      </button>
      <button mat-raised-button color="warn" type="button" (click)="onCancel()" [disabled]="isLoading">
        Cancelar
      </button>
    </div>
  </form>
</div>